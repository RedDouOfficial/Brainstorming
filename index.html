<style>
    * {
        box-sizing: border-box;
        color: white;
        font-family: "等线";
    }

    html,
    body {
        margin: 0;
        padding: 0;
        background-color: #1f2223;
    }

    aside {
        width: 380px;
        margin: 15px;

        &>* {
            border-radius: 1em;
        }

        &>#input-area {
            background-color: #4d5156;
            padding: 1em;
            width: 100%;
            height: 5em;
            resize: none;
            outline: 0;
        }

        &>#stage {
            background: linear-gradient(#4d5156, #1f2223) !important;
            white-space: normal;
            height: 80%;

            &>.miniCard {
                position: absolute;
                display: inline-block;
                cursor: grab;

                padding: 0.5em;
                margin: 5px;
                border-radius: 1em;

                font-weight: 700;

                box-shadow: 2px 2px 3px rgba(34, 34, 34, 0.325);
                min-width: 3em;
                min-height: 33px;
                vertical-align: middle;
                text-align: center;


                transition: box-shadow 0.3s ease;

                &:hover {
                    box-shadow: 2px 2px 3px rgba(34, 34, 34, 0.673);
                    /* transform: scale(1.05); */
                }

            }
        }
    }


    #topic {
        position: fixed;
        left: 55%;
        top: 5%;
        transform: translate(-50%, -50%);
        font-size: 50px;
        user-select: none;

        font-weight: 900;
    }
</style>

<body>
    <aside id="side-bar">
        <textarea id="input-area" autofocus></textarea>
        <pre id="stage"> </pre>
    </aside>

    <div id="topic">按下 T，输入本次主题</div>
</body>


<script>
    const inputAreaEle = document.querySelector("#input-area")
    const stageEle = document.querySelector("#stage")
    const sideBarEle = document.querySelector("#side-bar")
    const topicEle = document.querySelector("#topic")

    // 加载储存的数据
    let appState

    if (localStorage.getItem("appState")) appState = JSON.parse(localStorage.getItem("appState"))
    else appState = { cards: {} }


    // 写入
    function writeToLocal() {
        localStorage.setItem("appState", JSON.stringify(appState))
    }

    function updateOrCreated(card) {
        let cardEle = document.querySelector(`[data-id="${card.created}"]`)
        // console.log(cardEle)
        if (cardEle === null) {
            console.log("不存在，需要创建")
            cardEle = document.createElement("div")
            cardEle.className = "miniCard"
            cardEle.dataset.id = card.created
            stageEle.prepend(cardEle)
        }

        cardEle.style.position = card.stylePosition
        cardEle.style.left = card.position[0]
        cardEle.style.top = card.position[1]
        cardEle.style.zIndex = card.zIndex
        cardEle.textContent = card.content
        cardEle.style.background = card.bgc
    }


    function initAll() {
        sideBarEle.style.width = appState.sideBarWidth
        topicEle.textContent = appState.topic

        const list = Array.from(Object.keys(appState.cards)).map(id => appState.cards[id])
        for (let card of list) {
            updateOrCreated(card)
        }
    }
    initAll()

    // 回车就能创建================================================================

    inputAreaEle.addEventListener("keypress", (e) => {
        if (e.code === "Enter" && e.shiftKey === false) {
            console.log("用户按下Enter")
            e.preventDefault()
            const timestamp = Date.now()
            const inputContent = inputAreaEle.value

            inputAreaEle.value = ""


            const hue1 = Math.floor(Math.random() * 360)
            const hue2 = hue1 + 10
            const hue3 = hue1 + 20

            const color1 = `hsla(${hue1},100%,50%,0.5)`
            const color2 = `hsla(${hue2},100%,50%,0.5)`
            const color3 = `hsla(${hue3},100%,50%,0.5)`

            const degree = Math.floor(Math.random() * 360)

            const gradientStr = `linear-gradient(${degree}deg,${color1},${color2},${color3})`
            console.log(gradientStr)
            appState.cards[timestamp] = { content: inputContent, created: timestamp, position: [0, 0], size: [60, 90], zIndex: 1, stylePosition: "static", bgc: gradientStr }

            writeToLocal()
            updateOrCreated(appState.cards[timestamp])

        }
    })

    // ================================================================回车就能创建

    // 中键删除功能================================================================
    function deleteCard(id) {
        delete appState.cards[id]
        let cardEle = document.querySelector(`[data-id="${id}"]`)
        cardEle.parentElement.removeChild(cardEle)
        writeToLocal()
    }

    addEventListener("mousedown", e => {
        // console.dir(e)
        if (e.button === 1 && e.target.matches(".miniCard")) {
            e.preventDefault()
            deleteCard(e.target.dataset.id)
        }
    })
    // ================================================================中键删除功能


    // 全部清空功能================================================================

    addEventListener("keypress", e => {
        console.dir(e)
        if (e.code === "KeyQ" && e.shiftKey && e.ctrlKey) {
            appState = { cards: {} }
            localStorage.clear()
            console.dir(appState)
            initAll()
        }
    })

    // ================================================================全部清空功能


    // 卡片拖动================================================================
    function getMaxZIndex() {
        return Array.from(Object.keys(appState.cards)).map(id => appState.cards[id].zIndex).reduce((a, b) => Math.max(a, b), 1)
    }

    stageEle.addEventListener("mousedown", e => {
        e.preventDefault()
        if (e.target.className === "miniCard") {
            const timestamp = e.target.dataset.id
            const initClient = [e.clientX, e.clientY]
            const initPos = [e.target.offsetLeft, e.target.offsetTop]

            appState.cards[timestamp].stylePosition = "absolute"
            appState.cards[timestamp].zIndex = getMaxZIndex() + 1


            let lastE
            function startMove(e) {
                // document.documentElement.style.cursor = "grabbing"
                // e.target.style.cursor = "grabbing"

                lastE = e
                console.dir(e)
                const currentClient = [e.clientX, e.clientY]
                const dx = currentClient[0] - initClient[0]
                const dy = currentClient[1] - initClient[1]
                appState.cards[timestamp].position = [initPos[0] + dx, initPos[1] + dy]
                updateOrCreated(appState.cards[timestamp])
                writeToLocal()

            }

            function cancelBind() {
                removeEventListener("mousemove", startMove)
                removeEventListener("mouseup", endMove)
            }

            function endMove() {
                if (lastE.clientX <= stageEle.clientWidth) {
                    appState.cards[timestamp].stylePosition = "static"
                    e.target.style.position = "static"
                }
                // document.documentElement.style.cursor = "default"
                // e.target.style.cursor = "default"
                writeToLocal()
                cancelBind()
            }

            addEventListener("mousemove", startMove)
            addEventListener("mouseup", endMove)

            writeToLocal()
        }
    })
    // ================================================================卡片拖动


    // 双击搜索功能================================================================
    addEventListener("dblclick", e => {
        console.dir(e)

        if (e.target.matches(".miniCard")) {
            console.log("用户双击了卡片")
            const keyword = e.target.textContent
            window.open(`https://www.google.com/search?q=${keyword}`, "_blank");
        }
    })
    // ================================================================双击搜索功能



    // aside 宽度调整功能 ================================================================


    sideBarEle.addEventListener("mousemove", e => {
        if (e.clientX > sideBarEle.clientWidth * 0.9 && e.clientX < sideBarEle.clientWidth) {
            document.documentElement.style.cursor = "grab"
        } else {
            document.documentElement.style.cursor = "default"
        }
    })
    sideBarEle.addEventListener("mousedown", e => {
        if (e.target.matches("pre#stage")) {
            console.dir(e)
            const initClientX = e.clientX
            const initWidth = sideBarEle.clientWidth


            function startAdjust(e) {
                dx = e.clientX - initClientX
                sideBarEle.style.width = appState.sideBarWidth = Math.min(Math.max(200, initWidth + dx), 1880)
                writeToLocal()
                document.documentElement.style.cursor = "move"
            }
            function cancelBind(e) {
                removeEventListener("mousemove", startAdjust)
                removeEventListener("mouseup", endAdjust)
            }

            function endAdjust(e) {
                document.documentElement.style.cursor = "default"
                cancelBind(e)
            }

            addEventListener("mousemove", startAdjust)
            addEventListener("mouseup", endAdjust)
        }

    })

    //  ================================================================ aside 宽度调整功能

    // 全部清空功能================================================================

    addEventListener("keypress", e => {
        console.dir(e)
        if (e.code === "KeyT") {
            const topic = prompt("请输入本次围绕的主题")
            topicEle.textContent = appState.topic = topic
            writeToLocal()
        }
    })

    // ================================================================全部清空功能


</script>