<style>
    * {
        background-color: rgba(0, 0, 0, 0.08);
        box-shadow: inset 0 0 1px red;
        box-sizing: border-box;
    }

    .miniCard {
        position: absolute;
        cursor: pointer;
        /* 鼠标悬停时变成抓手 */
        width: fit-content;
        padding: 5px;
        border-radius: 10px;
        border: 2px solid black;
        transform: translate(-50%, -50%);
    }

    #birth {
        position: absolute;
        background-color: rgba(67, 196, 205, 0.135);
        width: 60px;
        height: 60px;
        border-radius: 30px;
        left: 150px;
        top: 200px;
        z-index: 0;
    }
</style>

<body>
    <textarea id="input-area" style="width: 100%;"></textarea>
    <pre id="stage" style="height: 90%;"> </pre>
    <div id="birth"></div>
</body>


<script>
    const inputAreaEle = document.querySelector("#input-area")
    const stageEle = document.querySelector("#stage")
    const helper = document.querySelector("#birth")

    let appState




    if (localStorage.getItem("appState")) {
        appState = JSON.parse(localStorage.getItem("appState"))
    } else {
        appState = { cards: {}, XX: "xxx" }
    }



    stageEle.addEventListener("click", (e) => {
        appState.birthCenter = [e.clientX, e.clientY]
        console.log("出生点更新为", appState.birthCenter)
        helper.style.left = e.clientX - 30
        helper.style.top = e.clientY - 30
    })





    function writeToLocal() {
        localStorage.setItem("appState", JSON.stringify(appState))
    }
    // localStorage.clear()
    // console.dir(appState)



    function updateOrCreated(card) {
        let cardEle = document.querySelector(`div[data-id="${card.created}"]`)
        // console.log(cardEle)
        if (cardEle === null) {
            console.log("不存在，需要创建")
            cardEle = document.createElement("div")
            cardEle.className = "miniCard"
            cardEle.dataset.id = card.created
            stageEle.appendChild(cardEle)

        }

        cardEle.style.left = card.position[0]
        cardEle.style.top = card.position[1]
        // cardEle.style.width = card.size[0]
        // cardEle.style.height = card.size[1]
        cardEle.style.zIndex = card.zIndex
        cardEle.textContent = card.content


    }


    function deleteCard(id) {
        delete appState.cards[id]
        let cardEle = document.querySelector(`div[data-id="${id}"]`)
        cardEle.parentElement.removeChild(cardEle)
        writeToLocal()
    }

    addEventListener("mousedown", e => {
        console.dir(e)
        if (e.button === 1 && e.target.className === "miniCard") {
            e.preventDefault()
            deleteCard(e.target.dataset.id)
        }
    })


    function initAll() {
        const list = Array.from(Object.keys(appState.cards)).map(id => appState.cards[id])
        for (let card of list) {
            updateOrCreated(card)
        }
    }
    initAll()
    // console.dir(inputAreaEle)
    inputAreaEle.addEventListener("keypress", (e) => {
        // console.dir(e)
        if (e.code === "Enter" && e.shiftKey === false) {
            console.log("用户按下Enter")
            e.preventDefault()
            const timestamp = Date.now()

            const inputContent = inputAreaEle.value
            inputAreaEle.value = ""
            appState.cards[timestamp] = { content: inputContent, created: timestamp, position: appState.birthCenter, size: [60, 90], zIndex: 1 }
            writeToLocal()
            updateOrCreated(appState.cards[timestamp])

        }
    })



    function getMax() {
        return Array.from(Object.keys(appState.cards)).map(id => appState.cards[id].zIndex).reduce((a, b) => Math.max(a, b), 1)
    }


    stageEle.addEventListener("mousedown", e => {


        e.preventDefault()
        // console.dir(e)

        if (e.target.className === "miniCard") {
            // console.log("YES")
            const timestamp = e.target.dataset.id
            const initClient = [e.clientX, e.clientY]
            const initPos = appState.cards[timestamp].position
            // console.log(initPos)

            appState.cards[timestamp].zIndex = getMax() + 1
            console.log("当前最大", getMax())

            function startMove(e) {
                const currentClient = [e.clientX, e.clientY]
                const dx = currentClient[0] - initClient[0]
                const dy = currentClient[1] - initClient[1]
                appState.cards[timestamp].position = [initPos[0] + dx, initPos[1] + dy]
                updateOrCreated(appState.cards[timestamp])
                writeToLocal()
            }

            function cancelBind() {
                removeEventListener("mousemove", startMove)
                removeEventListener("mouseup", cancelBind)
            }
            addEventListener("mousemove", startMove)
            addEventListener("mouseup", cancelBind)
            writeToLocal()
        }

    })


</script>