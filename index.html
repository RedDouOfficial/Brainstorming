<style>
    * {
        background-color: rgba(0, 0, 0, 0.08);
        box-shadow: inset 0 0 1px red;
    }

    .miniCard {
        position: absolute;
        cursor: pointer;
        /* 鼠标悬停时变成抓手 */
    }
</style>

<body>
    <textarea id="input-area" style="width: 100%;">默认测试用</textarea>
    <div id="stage" style="height: 90%;"> </div>
</body>


<script>
    let appState
    if (localStorage.getItem("appState")) {
        appState = JSON.parse(localStorage.getItem("appState"))
    } else {
        appState = { cards: {}, XX: "xxx" }
    }


    function writeToLocal() {
        localStorage.setItem("appState", JSON.stringify(appState))
    }
    // localStorage.clear()
    // console.dir(appState)

    const inputAreaEle = document.querySelector("#input-area")
    const stageEle = document.querySelector("#stage")

    function updateOrCreated(card) {
        let cardEle = document.querySelector(`textarea[data-id="${card.created}"]`)
        // console.log(cardEle)
        if (cardEle === null) {
            console.log("不存在，需要创建")
            cardEle = document.createElement("textarea")
            cardEle.className = "miniCard"
            cardEle.dataset.id = card.created
            stageEle.appendChild(cardEle)

        }

        cardEle.style.left = card.position[0]
        cardEle.style.top = card.position[1]
        cardEle.style.width = card.size[0]
        cardEle.style.height = card.size[1]
        cardEle.style.zIndex = card.zIndex
        cardEle.value = card.content


    }



    function initAll() {
        const list = Array.from(Object.keys(appState.cards)).map(id => appState.cards[id])
        for (let card of list) {
            updateOrCreated(card)
        }
    }
    initAll()
    // console.dir(inputAreaEle)
    inputAreaEle.addEventListener("keypress", (e) => {
        // console.dir(e)
        if (e.code === "Enter" && e.shiftKey === false) {
            console.log("用户按下Enter")
            e.preventDefault()
            const timestamp = Date.now()

            const inputContent = inputAreaEle.value
            inputAreaEle.value = ""
            appState.cards[timestamp] = { content: inputContent, created: timestamp, position: [360, 360], size: [60, 90], zIndex: 1 }
            writeToLocal()
            updateOrCreated(appState.cards[timestamp])

        }
    })



    function getMax() {
        return Array.from(Object.keys(appState.cards)).map(id => appState.cards[id].zIndex).reduce((a, b) => Math.max(a, b), 1)
    }


    stageEle.addEventListener("mousedown", e => {


        e.preventDefault()
        // console.dir(e)

        if (e.target.className === "miniCard") {
            // console.log("YES")
            const timestamp = e.target.dataset.id
            const initClient = [e.clientX, e.clientY]
            const initPos = appState.cards[timestamp].position
            // console.log(initPos)

            appState.cards[timestamp].zIndex = getMax() + 1
            console.log("当前最大", getMax())

            function startMove(e) {
                const currentClient = [e.clientX, e.clientY]
                const dx = currentClient[0] - initClient[0]
                const dy = currentClient[1] - initClient[1]
                appState.cards[timestamp].position = [initPos[0] + dx, initPos[1] + dy]
                updateOrCreated(appState.cards[timestamp])
                writeToLocal()
            }

            function cancelBind() {
                removeEventListener("mousemove", startMove)
                removeEventListener("mouseup", cancelBind)
            }
            addEventListener("mousemove", startMove)
            addEventListener("mouseup", cancelBind)
            writeToLocal()
        }

    })


</script>