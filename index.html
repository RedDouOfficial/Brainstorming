<style>
    :root {
        --card-color: white
    }

    * {
        /* box-sizing: border-box;
        color: rgb(1, 22, 255); */
        /* font-family: "等线"; */
    }

    html,
    body {
        margin: 0;
        padding: 0;
        background-color: #1f2223;
    }

    aside {
        width: 380px;
        margin: 15px;

        &>* {
            border-radius: 1em;
        }

        &>#input-area {
            background-color: #4d5156;
            color: white;
            padding: 1em;
            width: 100%;
            height: 5em;
            resize: none;
            outline: 0;
        }

        &>#stage {
            background: linear-gradient(#4d5156, #1f2223) !important;
            white-space: normal;
            height: 80%;

            &>.miniCard {
                position: absolute;
                display: inline-block;
                cursor: grab;

                padding: 0.5em;
                margin: 5px;
                border-radius: 1em;


                font-weight: 700;

                box-shadow: 2px 2px 3px rgba(34, 34, 34, 0.325);
                /* min-width: 3em;
                min-height: 33px; */
                vertical-align: middle;
                text-align: center;

                white-space: pre-line;

                transition: box-shadow 0.3s ease, filter .1s, color .1s;


                &:hover {
                    box-shadow: 2px 2px 3px rgba(34, 34, 34, 0.673);
                    /* transform: scale(1.05); */
                }

            }
        }
    }


    #topic {
        position: fixed;
        left: 55%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-family: Georgia, 'Times New Roman', Times, serif;
        font-size: 120px;
        user-select: none;
        opacity: 0.1;
        font-weight: 900;
        width: 100%;
        text-align: center;
    }

    .miniCard,
    #topic {
        /* filter: blur(2px); */
        color: var(--card-color);

        &:hover {
            color: rgb(255, 255, 255);
            /* filter: blur(0); */
        }

    }

    #toolbar {
        background-color: #1f2223;
        padding: 5px;

        color: black;

        & button {
            color: rgb(0, 0, 0);
        }

    }
</style>

<body>
    <div id="toolbar">
        <select id="file-explorer" style="min-width: 150px ;height: 25px;"> </select>
        <button onclick="createNewTopic()">创建新画布</button>
        <button onclick="deleteCurrentTopic()">删除当前画布</button>
        <button onclick="editCurrentTopic()">编辑话题</button>
        <button onclick="resetAll()">清空一切</button>
        <button onclick="currentToClipboard()">导出当前笔记</button>
        <button onclick="exportAll()">备份·导出</button>
        <button onclick="importAll()">备份·导入</button>
        <button onclick="switchSecretMode()">隐私模式切换</button>
        <button onclick="pureMode()">纯净模式</button>
    </div>


    <aside id="side-bar">

        <textarea id="input-area" autofocus></textarea>
        <pre id="stage"> </pre>
    </aside>

    <div id="topic">按下 T，输入本次主题</div>
</body>


<script>
    const inputAreaEle = document.querySelector("#input-area")
    const stageEle = document.querySelector("#stage")
    const sideBarEle = document.querySelector("#side-bar")
    const topicEle = document.querySelector("#topic")
    const fileExplorerEle = document.querySelector("#file-explorer")
    const toolBarEle = document.querySelector("#toolbar")

    // 加载储存的数据
    let appState

    if (localStorage.getItem("appState")) appState = JSON.parse(localStorage.getItem("appState"))
    else appState = {
        notes: {
            "10000000": {
                topic: "Object To BUY",
                cards: {},
                id: "10000000"
            }
        },
        currentNoteId: "10000000",
        sideBarWidth: 200,
        secretMode: false
    }

    // 写入
    function writeToLocal() {
        localStorage.setItem("appState", JSON.stringify(appState))
    }


    function exportAll() {
        const output = JSON.stringify(appState)
        navigator.clipboard.writeText(output)
    }
    function importAll() {
        const inputStr = prompt("请输入导出的数据")
        if (inputStr.trim() !== "") {
            appState = JSON.parse(inputStr)
            writeToLocal()
            initAll()
        }
    }

    function updateOrCreated(card) {
        let cardEle = document.querySelector(`[data-id="${card.created}"]`)
        // console.log(cardEle)
        if (cardEle === null) {
            // console.log("不存在，需要创建")
            cardEle = document.createElement("div")
            cardEle.className = "miniCard"
            cardEle.dataset.id = card.created
            stageEle.prepend(cardEle)
        }

        cardEle.style.position = card.stylePosition
        cardEle.style.left = card.position[0]
        cardEle.style.top = card.position[1]
        cardEle.style.zIndex = card.zIndex
        cardEle.textContent = card.content
        cardEle.style.background = card.bgc
    }



    function updateFileExplorerView() {
        fileExplorerEle.innerHTML = ""
        for (let id in appState.notes) {
            const optionEle = document.createElement("option")
            optionEle.value = id
            optionEle.textContent = appState.notes[id].topic
            fileExplorerEle.appendChild(optionEle)
        }
        fileExplorerEle.value = appState.currentNoteId
    }

    fileExplorerEle.addEventListener("change", e => {
        switchNote(fileExplorerEle.value)
    })

    function switchNote(id) {
        appState.currentNoteId = id
        writeToLocal()
        initAll()
    }


    function initAll() {
        updateFileExplorerView()
        updateSecretModeView()
        stageEle.innerHTML = ""
        sideBarEle.style.width = appState.sideBarWidth
        topicEle.textContent = appState.notes[appState.currentNoteId].topic ?? ""

        const list = Array.from(Object.keys(appState.notes[appState.currentNoteId].cards)).map(id => appState.notes[appState.currentNoteId].cards[id])
        for (let card of list) {
            updateOrCreated(card)
        }
    }
    initAll()

    // 回车就能创建================================================================

    function genRandomGradient() {
        const hue1 = Math.floor(Math.random() * 360)
        const hue2 = hue1 + 15
        const hue3 = hue1 + 30
        const color1 = `hsla(${hue1},100%,50%,0.5)`
        const color2 = `hsla(${hue2},100%,50%,0.5)`
        const color3 = `hsla(${hue3},100%,50%,0.5)`

        const degree = Math.floor(Math.random() * 360)

        const gradientStr = `linear-gradient(${degree}deg,${color1},${color2},${color3})`

        return gradientStr
    }

    inputAreaEle.addEventListener("keypress", (e) => {
        if (e.code === "Enter" && e.shiftKey === false) {
            // console.log("用户按下Enter")
            e.preventDefault()
            const timestamp = Date.now()
            const inputContent = inputAreaEle.value

            inputAreaEle.value = ""

            const gradientStr = genRandomGradient()
            appState.notes[appState.currentNoteId].cards[timestamp] = { content: inputContent, created: timestamp, position: [0, 0], size: [60, 90], zIndex: 1, stylePosition: "static", bgc: gradientStr }

            writeToLocal()
            updateOrCreated(appState.notes[appState.currentNoteId].cards[timestamp])

        }
    })

    // ================================================================回车就能创建

    // 中键删除功能================================================================
    function deleteCard(id) {
        delete appState.notes[appState.currentNoteId].cards[id]
        let cardEle = document.querySelector(`[data-id="${id}"]`)
        cardEle.parentElement.removeChild(cardEle)
        writeToLocal()
    }

    addEventListener("mousedown", e => {
        // console.dir(e)
        if (e.button === 1 && e.target.matches(".miniCard")) {
            e.preventDefault()
            deleteCard(e.target.dataset.id)
        }
    })
    // ================================================================中键删除功能


    // 全部清空功能================================================================
    function resetAll() {
        const sureText = prompt("将会重置一切。确认请输入：确认删除一切")
        if (sureText === "确认删除一切") {
            appState = {}
            localStorage.clear()
            console.dir(appState)
            initAll()
        }
    }
    addEventListener("keypress", e => {
        console.dir(e)
        if (e.code === "KeyQ" && e.shiftKey && e.ctrlKey) {
            resetAll()
        }
    })

    // ================================================================全部清空功能


    // 卡片拖动================================================================
    function getMaxZIndex() {
        return Array.from(Object.keys(appState.notes[appState.currentNoteId].cards)).map(id => appState.notes[appState.currentNoteId].cards[id].zIndex).reduce((a, b) => Math.max(a, b), 1)
    }

    stageEle.addEventListener("mousedown", e => {
        e.preventDefault()
        if (e.target.className === "miniCard") {
            const timestamp = e.target.dataset.id
            const initClient = [e.clientX, e.clientY]
            const initPos = [e.target.offsetLeft, e.target.offsetTop]

            appState.notes[appState.currentNoteId].cards[timestamp].stylePosition = "absolute"
            appState.notes[appState.currentNoteId].cards[timestamp].zIndex = getMaxZIndex() + 1


            let lastE
            function startMove(e) {
                // document.documentElement.style.cursor = "grabbing"
                // e.target.style.cursor = "grabbing"

                lastE = e
                // console.dir(e)
                const currentClient = [e.clientX, e.clientY]
                const dx = currentClient[0] - initClient[0]
                const dy = currentClient[1] - initClient[1]
                appState.notes[appState.currentNoteId].cards[timestamp].position = [initPos[0] + dx, initPos[1] + dy]
                updateOrCreated(appState.notes[appState.currentNoteId].cards[timestamp])
                writeToLocal()

            }

            function cancelBind() {
                removeEventListener("mousemove", startMove)
                removeEventListener("mouseup", endMove)
            }

            function endMove() {
                if (lastE && lastE.clientX <= stageEle.clientWidth) {
                    appState.notes[appState.currentNoteId].cards[timestamp].stylePosition = "static"
                    e.target.style.position = "static"
                }
                // document.documentElement.style.cursor = "default"
                // e.target.style.cursor = "default"
                writeToLocal()
                cancelBind()
            }

            addEventListener("mousemove", startMove)
            addEventListener("mouseup", endMove)

            writeToLocal()
        }
    })
    // ================================================================卡片拖动


    // 双击搜索功能================================================================
    addEventListener("dblclick", e => {
        // console.dir(e)

        if (e.target.matches(".miniCard")) {
            console.log("用户双击了卡片")
            const keyword = e.target.textContent
            window.open(`https://www.google.com/search?q=${keyword}`, "_blank");
        }
    })
    // ================================================================双击搜索功能



    // aside 宽度调整功能 ================================================================


    sideBarEle.addEventListener("mousemove", e => {
        if (e.clientX > sideBarEle.clientWidth * 0.9 && e.clientX < sideBarEle.clientWidth) {
            document.documentElement.style.cursor = "grab"
        } else {
            document.documentElement.style.cursor = "default"
        }
    })
    sideBarEle.addEventListener("mousedown", e => {
        if (e.target.matches("pre#stage")) {
            // console.dir(e)
            const initClientX = e.clientX
            const initWidth = sideBarEle.clientWidth


            function startAdjust(e) {
                dx = e.clientX - initClientX
                sideBarEle.style.width = appState.sideBarWidth = Math.min(Math.max(200, initWidth + dx), 1880)
                writeToLocal()
                document.documentElement.style.cursor = "move"
            }
            function cancelBind(e) {
                removeEventListener("mousemove", startAdjust)
                removeEventListener("mouseup", endAdjust)
            }

            function endAdjust(e) {
                document.documentElement.style.cursor = "default"
                cancelBind(e)
            }

            addEventListener("mousemove", startAdjust)
            addEventListener("mouseup", endAdjust)
        }

    })

    //  ================================================================ aside 宽度调整功能

    // 编辑题目功能================================================================

    function editCurrentTopic() {
        const topic = prompt("请编辑本次围绕的主题", appState.notes[appState.currentNoteId].topic ?? "")
        topicEle.textContent = appState.notes[appState.currentNoteId].topic = topic
        writeToLocal()
        initAll()
    }

    addEventListener("keypress", e => {
        // console.dir(e)
        if (e.code === "KeyT") {
            editCurrentTopic()
        }
    })

    // ================================================================编辑题目功能


    // 导出数据功能================================================================
    function currentToClipboard() {
        const text = Array.from(Object.keys(appState.notes[appState.currentNoteId].cards)).map(id => appState.notes[appState.currentNoteId].cards[id].content).join("\n")
        navigator.clipboard.writeText(text)
    }

    addEventListener("keypress", e => {
        if (e.code === "KeyE") {
            e.preventDefault()
            currentToClipboard()
        }
    })

    // ================================================================导出数据功能


    // Create new Topic ================================================================
    function createNewTopic() {
        const timestamp = Date.now()
        const topic = prompt("请输入本次围绕的主题")
        if (topic !== "") {
            if (!appState.notes) { appState.notes = {} }
            appState.notes[timestamp] = { topic: topic, cards: {}, id: timestamp }
            appState.currentNoteId = timestamp
            writeToLocal()
            initAll()
        }

    }

    addEventListener("keypress", e => {
        if (e.code === "KeyN") {
            createNewTopic()
        }
    })
    // ================================================================ Create new Topic



    function deleteCurrentTopic() {
        delete appState.notes[appState.currentNoteId]
        writeToLocal()
        initAll()
    }

    // ↑↓切换笔记================================================================

    addEventListener("keyup", e => {
        if (e.code === "ArrowDown" || e.code === "ArrowUp") {
            const keyList = Object.keys(appState.notes)
            if (e.code === "ArrowDown") { addDidff = +1 } else if (e.code === "ArrowUp") { addDidff = -1 }
            const nextIdx = (Number(keyList.length + keyList.indexOf(appState.currentNoteId)) + addDidff) % keyList.length
            appState.currentNoteId = keyList[nextIdx]
            // console.log(appState.currentNoteId)
            writeToLocal()
            initAll()
            console.log(keyList.map(key => (key === keyList[nextIdx] ? "> " : "  ") + appState.notes[key].topic).join("\n"))
        }
    })
    // ================================================================↑↓切换笔记



    // 隐私模式================================================================

    function updateSecretModeView() {
        if (appState.secretMode) {
            document.documentElement.style.setProperty('--card-color', ' rgb(255, 255, 255,0)');
        } else {
            document.documentElement.style.setProperty('--card-color', ' rgb(255, 255, 255,1)');
        }
    }


    function switchSecretMode() {
        appState.secretMode = !appState.secretMode
        writeToLocal()
        updateSecretModeView()
    }


    addEventListener("keypress", e => {
        if (e.code === "KeyS") switchSecretMode()
    })
    // ================================================================隐私模式


    function pureMode() {
        toolBarEle.style.display = "none"
    }

    function completeMode() {
        toolBarEle.style.display = "block"
    }

    addEventListener("keyup", e => {
        console.dir(e)
        if (e.code === "Escape") completeMode()
    })
</script>